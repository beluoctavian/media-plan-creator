<?php

/**
 * Implements hook_menu().
 */
function zeddigital_menu() {
  return array(
    'node/%node/delete_programmatically' => array(
      'title' => t('Delete'),
      'page callback' => 'redirect_to_node_delete',
      'access callback' => 'zeddigital_node_delete_access',
      'access arguments' => array($node),
      'callback arguments' => array($node),
      'type' => MENU_LOCAL_TASK,
      'weight' => 3,
    ),
    'node/%node/export_to_excel' => array(
      'title' => t('Export to EXCEL'),
      'page callback' => 'zeddigital_export_node_to_excel',
      'access callback' => 'zeddigital_node_export_access',
      'access arguments' => array($node),
      'callback arguments' => array($node),
      'type' => MENU_LOCAL_TASK,
      'weight' => 4,
    ),
  );
}

/**
 * Check if the user can delete the current node.
 */
function zeddigital_node_delete_access() {
  global $user;
  $node = node_load(arg(1));
  return node_access('delete', $node, $user);
}

/**
 * Check if the user can export the current node.
 */
function zeddigital_node_export_access() {
  global $user;
  $node = node_load(arg(1));
  return node_access('view', $node, $user);
}

/**
 * Helper function for menu_local_task.
 */
function redirect_to_node_delete() {
  if (arg(0) == 'node' && arg(1) && is_numeric(arg(1))) {
    drupal_goto('node/' . arg(1) . '/delete');
  }
}

function _zeddigital_set_excel_header_data(array &$data, $node_wrapper) {
  $data[3][1] = 'Client:';
  $data[3][2] = $node_wrapper->field_client->value();
  $data[4][1] = 'Brand:';
  $data[4][2] = $node_wrapper->field_brand->value();
  $data[5][1] = 'Campaign:';
  $data[5][2] = $node_wrapper->field_campaign->value();
  $data[6][1] = 'Media Target Audience:';
  $data[6][2] = $node_wrapper->field_media_target_audience->value();
  $data[7][1] = 'Period';
  $start_date = $node_wrapper->field_period->value->value();
  $end_date = $node_wrapper->field_period->value2->value();
  $data[7][2] = gmdate('d M Y - ', $start_date) . gmdate('d M Y', $end_date);
  return 19;
}

/**
 * Export node to EXCEL.
 */
function zeddigital_export_node_to_excel() {
  if (arg(0) == 'node' && arg(1) && is_numeric(arg(1))) {
    module_load_include('inc', 'phpexcel');
    $data = array();
    $node = node_load(arg(1));
    dpm($node);
    $node_wrapper = entity_metadata_wrapper('node', $node);
    $row_num = _zeddigital_set_excel_header_data($data, $node_wrapper);
    dpm($data);



    foreach ($node_wrapper->field_categories as $category) {
      $category_title = $category->field_category_title->label();
      foreach ($category->field_websites as $website) {
        $site_name = $website->field_site->label();
        $supplier = $website->field_supplier->label();
        $site_category = $website->field_category->label();
        $ad_format = $website->field_ad_format->label();
        $campaign_type = $website->field_campaign_type->label();
        $bought_adviews = $website->field_bought_adviews->value();
        $cpm = $website->field_cpm->value();
        $total_net_budget = $website->field_total_net_budget->value();
      }
    }
    drupal_goto('node/' . $node->nid);
  }
}

/**
 * Implements hook_form_alter().
 */
function zeddigital_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'media_plan_node_form':
      unset($form['title']);
      break;
  }
}

/**
 * Implements hook_node_insert().
 */
function zeddigital_node_insert($node) {
  if ($node->type == 'media_plan') {
    $title = $node->nid;
    $title .= '_' . $node->field_brand[LANGUAGE_NONE][0]['name'];
    $title = str_replace(' ', '-', $title);
    db_update('node')
      ->fields(array('title' => $title,))
      ->condition('nid', $node->nid)
      ->execute();
    db_update('node_revision')
      ->fields(array('title' => $title,))
      ->condition('nid', $node->nid)
      ->execute();
  }
}

/**
 * Implements hook_field_widget_form_alter().
 */
function zeddigital_field_widget_form_alter(&$element, &$form_state, $context) {
  // TO DO: AJAX AUTOCOMPLETE
  if (!empty($element['#bundle']) && $element['#bundle'] == 'field_websites' && $element['#field_name'] == 'field_websites') {
    $field_bouglt_adviews = &$element['field_bought_adviews'];
    $field_cpm = &$element['field_cpm'];
    $field_total_net_budget = &$element['field_total_net_budget'];

    $field_bouglt_adviews['#attributes']['delta_website'] = array($context['delta']);
    $field_cpm['#attributes']['delta_website'] = array($context['delta']);
    $field_total_net_budget['#attributes']['delta_website'] = array($context['delta']);
    $field_total_net_budget['#attributes']['disabled'] = array('disabled');
  }
}